# =========================================================
# üåê NGINX configuration - Environnement STAGE (localhost)
# =========================================================

# ====== Global map (WebSocket / SSE upgrade) ======
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# ====== HTTP (port 80) ======
server {
  listen 80;
  server_name _;

  # --- Redirection automatique vers HTTPS ---
  return 301 https://$host$request_uri;
}

# ====== HTTPS (port 443) ======
server {
  listen 443 ssl;
  server_name localhost;

  # --- Certificats auto-sign√©s g√©n√©r√©s par restart-stage.sh ---
  ssl_certificate     /etc/nginx/certs/localhost.crt;
  ssl_certificate_key /etc/nginx/certs/localhost.key;

  # --- En-t√™tes proxy communs ---
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Upgrade           $http_upgrade;
  proxy_set_header Connection        $connection_upgrade;

  # --- Static frontend React ---
  location / {
    proxy_pass http://social_web:80/;
    proxy_buffering off;
  }

  # --- API Django ---
  location /api/ {
    proxy_pass http://social_backend:8000/;
    proxy_redirect off;
    proxy_buffering off;
  }

  # --- Endpoint sant√© (texte brut) ---
  location /health {
    return 200 "OK\n";
    add_header Content-Type text/plain;
  }

  # --- Page statique de test (health.html) ---
  location = /health.html {
    root /usr/share/nginx/html;
  }

  # --- S√©curit√© minimale ---
  add_header X-Frame-Options "SAMEORIGIN";
  add_header X-Content-Type-Options "nosniff";
  add_header Referrer-Policy "strict-origin-when-cross-origin";
}
